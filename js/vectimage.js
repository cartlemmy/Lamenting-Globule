// Lamenting Globule 0.0 (Apathetic Amoeba)
// Vector Image Renderer
// lg.vectimage
// (c) 2011 Josh "CartLemmy" Merritt
// cartlemmy@gmail.com
// http://www.yibbleware.com


function lgVectimage(o){this.setOptions=function(o){for(i in o){var n="set"+i.charAt(0).toUpperCase()+i.substr(1);if(this[n]){this[n](o[i])}else{this[i]=o[i]}}};this.setCallback=function(a){this.callback=a};this.styleMask=function(a){if(typeof(a)=="string"){var a=a.split(",");var b=0;for(var i=0;i<a.length;i++){if(this.styles.indexOf(a[i])!=-1){b=b|Math.pow(2,this.styles.indexOf(a[i]))}}}else{var b=a}return b};this.setCtx=function(a){this.mainCtx=a;if(a!=null){a.canvas.ob=this;a.canvas.onclick=function(e){this.ob.doCallback("click",e)};a.canvas.style.cursor="pointer";this.width=a.canvas.width;this.height=a.canvas.height}};this.setData=function(a){this.loading=0;if(a.global){for(var i in a.global){this.global[i]=a.global[i].value!=undefined?a.global[i].value:a.global[i]}}this.data=a;this.preload()};this.setAttr=function(n,v,d){switch(n){case"fillStyle":if(typeof(v)=="object"){if(v.r1){var g=this.ctx.createRadialGradient(v.x1-d.x,v.y1-d.y,v.r1,v.x2-d.x,v.y2-d.y,v.r2)}else{var g=this.ctx.createLinearGradient(v.x1-d.x,v.y1-d.y,v.x2-d.x,v.y2-d.y)}for(var i in v.stops){g.addColorStop(v.stops[i][0],v.stops[i][1])}this.ctx[n]=g;break}else{this.ctx[n]=v}break;case"angle":this.ctx.translate(d.x,d.y);this.ctx.rotate(v);this.ctx.translate(-d.x,-d.y);break;case"scale":this.ctx.translate(d.x,d.y);if(typeof(v)=="array"){this.ctx.scale(v[0],v[1])}else{this.ctx.scale(v,v)}this.ctx.translate(-d.x,-d.y);break;default:this.ctx[n]=v;break}};this.preload=function(){if(!this.data.layers){return}for(var i=0;i<this.data.layers.length;i++){this.doPreload(this.data.layers[i],{w:this.mainCtx.canvas.width,h:this.mainCtx.canvas.height})}};this.doPreload=function(d,a){if(!d.length){return}for(var i=0;i<d.length;i++){var b=d[i];this.calcAllParams(b,a);var c=typeof(b.t)=="number"?this.types[b.t]:b.t;switch(c){case"img":var n=simpleHash(b.image?b.image:b.src);if(!this.images[n]){this.images[n]=new Image();this.images[n].src=b.image?this.data.images[b.image]:b.src;this.images[n].ob=this;this.images[n].onload=function(){this.ob.loading--;if(this.ob.loading==0){this.ob.loaded()}};this.loading++}break;case"children":this.doPreload(b.c,b);break}}};this.loaded=function(){if(this.renderOnLoad){this.render()}};this.render=function(){if(this.loading){this.renderOnLoad=true;return false}this.mainCtx.clearRect(0,0,this.mainCtx.canvas.width,this.mainCtx.canvas.height);for(var i=0;i<this.data.layers.length;i++){var a=document.createElement('canvas');a.setAttribute('width',this.mainCtx.canvas.width);a.setAttribute('height',this.mainCtx.canvas.height);this.ctx=a.getContext('2d');this.doRender(this.data.layers[i],{w:this.mainCtx.canvas.width,h:this.mainCtx.canvas.height});this.mainCtx.drawImage(this.ctx.canvas,0,0)}this.doCallback("rendered");if(this.cache){var b=new serverRequestInterface(this,this.cacheHandler?this.cacheHandler:"lg.php");var c=this.mainCtx.canvas.toDataURL("image/"+this.cache.split(".").pop());b.request('cacheImage',{file:this.cache,data:c})}return true};this.doRender=function(d,a){if(!d.length){return}for(var i=0;i<d.length;i++){var b=d[i];var c=typeof(b.t)=="number"?this.types[b.t]:b.t;if(c!="translate"){this.ctx.save()}var n="draw"+c.charAt(0).toUpperCase()+c.substr(1);if(typeof(this[n])=="function"){this.di=b;if(this.styleMask(b.s)&4){this.ctx.globalCompositeOperation="destination-out"}for(var j in this.conv){if(b[j]){this.setAttr(this.conv[j],b[j],b)}else if(b[this.conv[j]]){this.setAttr(this.conv[j],b[this.conv[j]],b)}}this.calcAllParams(b,a);this.ctx.beginPath();if(b.lw){this.ctx.lineWidth=b.lw}if(b.fs){this.ctx.fillStyle=b.fs}if(b.ss){this.ctx.strokeStyle=b.ss}if(this[n](b)){if(this.styleMask(b.s)&1){this.ctx.stroke()}if(this.styleMask(b.s)&2||this.styleMask(b.s)&4){this.ctx.fill()}if(this.styleMask(b.s)&8){this.ctx.clip()}}}if(c!="translate"){this.ctx.restore()}}};this.calcAllParams=function(a,b){var c=["lw","lc","lj","ml","sx","sy","sb","sc","fs","ss","tf","ta","tb","gco","ga","a","z","x","y","z","x1","y1","x2","y2","h","w","cx","cy","cx1","cy1","cx2","cy2","r","text","src"];for(var j in c){if(a[c[j]]!=undefined||a[c[j]+"_orig"]!=undefined){if(a[c[j]+"_orig"]==undefined&&typeof(a[c[j]])=="string"&&a[c[j]].substr(0,1)=="="){a[c[j]+"_orig"]=a[c[j]]}if(a[c[j]+"_orig"]!=undefined){a[c[j]]=this.calcParam(a[c[j]+"_orig"],a,b)}}}};this.calcParam=function(v,t,u){if(typeof(v)=="string"&&v.substr(0,1)=="="){var n=simpleHash(t.image?t.image:t.src);if(this.images[n]){t.width=this.images[n].naturalWidth;t.height=this.images[n].naturalHeight;t.prop=this.images[n].naturalWidth/this.images[n].naturalHeight}try{eval(("rv = "+v.substr(1)).split("this.").join("t.").split("lgvi.").join("this.").split("parent.").join("u.").split("global.").join("this.global.")+";")}catch(e){return null}return rv}return v};this.drawRect=function(d){this.ctx.rect(d.x,d.y,d.w,d.h);return true};this.drawArc=function(d){this.ctx.arc(d.x,d.y,d.r,d.a1,d.a2,d.acw);return true};this.drawCircle=function(d){this.ctx.arc(d.x,d.y,d.r,0,Math.PI*2,false);return true};this.drawChildren=function(d){this.ctx.save();this.ctx.translate(d.x,d.y);this.doRender(d.c,d);this.ctx.restore();return false};this.drawMulti=function(d){this.ctx.translate(d.x,d.y);this.ctx.beginPath();this.ctx.moveTo(0,0);for(var i in d.p){var a=d.p[i];this.calcAllParams(a,d);switch(a.t){case"move":this.ctx.moveTo(a.x,a.y);break;case"quad":this.ctx.quadraticCurveTo(a.cx,a.cy,a.x,a.y);break;case"bez":this.ctx.bezierCurveTo(a.cx1,a.cy1,a.cx2,a.cy2,a.x,a.y);break;default:this.ctx.lineTo(a.x,a.y);break}}this.ctx.closePath();return true};this.drawImg=function(d){var n=simpleHash(d.image?d.image:d.src);if(d.sx){this.ctx.drawImage(this.images[n],d.sx,d.sy,d.sw,d.sh,d.x,d.y,d.w,d.h)}else{this.ctx.drawImage(this.images[n],d.x,d.y,d.w,d.h)}return false};this.drawText=function(d){if(this.styleMask(d.s)&2){this.ctx.fillText(d.text,d.x,d.y)}if(this.styleMask(d.s)&1){this.ctx.strokeText(d.text,d.x,d.y)}return false};this.drawTranslate=function(d){this.ctx.translate(d.x,d.y)};this.drawFilter=function(d){var c=this.ctx.getImageData(0,0,this.ctx.canvas.width,this.ctx.canvas.height);var e=c.data;var f=this.ctx.canvas.width*this.ctx.canvas.height*4;switch(d.c){case"hsl":for(var i=0;i<f;i+=4){var a=e[i+3];var j=this.rgbToHsl(e[i]/255,e[i+1]/255,e[i+2]/255);var h=j[0],s=j[1],l=j[2];eval(d.f);var k=this.hslToRgb(h,s,l);e[i]=Math.round(k[0]*255);e[i+1]=Math.round(k[1]*255);e[i+2]=Math.round(k[2]*255);e[i+3]=a}break;case"rgb":default:for(var i=0;i<f;i+=4){var r=e[i],g=e[i+1],b=e[i+2],a=e[i+3];eval(d.f);e[i]=r;e[i+1]=g;e[i+2]=b;e[i+3]=a}break}c.data=e;this.ctx.putImageData(c,0,0)};this.fontStyle=function(a,b,c,d,e){if(!this.mainCtx)return;var f=32;this.mainCtx.font=(b?b+" ":"")+f+"px "+c;var g=0;var h=16;var i=0,bestDist=100;while(Math.abs(g=this.mainCtx.measureText(d).width-a)>1||i==0){f+=g>0?-h:h;h--;if(h<1)h=1;this.mainCtx.font=(b?b+" ":"")+f+"px "+c;if(Math.abs(g)<bestDist&&g<=0){bestDist=Math.abs(g);i=f}else if(h==1){break}}i=e?Math.min(e,i):i;this.mainCtx.font=(b?b+" ":"")+i+"px "+c;this.di.width=this.mainCtx.measureText(d).width;this.di.height=i;return(b?b+" ":"")+i+"px "+c};this.fit=function(w,h){if(!this.di)return{x:0,y:0,w:0,h:0};var a=w/h;if(this.di.prop>a){var b=w/this.di.prop;return{x:0,y:(h-b)/2,w:w,h:b}}else{var c=h*this.di.prop;return{x:(w-c)/2,y:0,w:c,h:h}}};this.el=function(a,b){if(!this.data.layers){return}var c=null;for(var i=0;i<this.data.layers.length;i++){if((c=this.doEl(a,this.data.layers[i]))!==null){return c}}return null};this.doEl=function(a,d){for(var i=0;i<d.length;i++){if(d[i].id&&d[i].id==a)return d[i];if(d[i].name=="children"){var b;if((b=this.doEl(a,d[i].c))!==null){return b}}}return null};this.doCallback=function(a,e){if(typeof(this.callback)=="function"){if(typeof(e)!="object"){e={}}e.type=a;this.callback(e)}};this.hslToRgb=function(h,s,l){var x,y,r,g,b;y=(l>.5)?l+s-l*s:l*(s+1);x=l*2-y;r=this.hToC(x,y,h+1/3);g=this.hToC(x,y,h);b=this.hToC(x,y,h-1/3);return[r,g,b]};this.rgbToHsl=function(r,g,b){var a=Math.max(r,g,b),mn=Math.min(r,g,b);var h,s,l=(a+mn)/2;if(a==mn){h=s=0}else{var d=a-mn;s=l>0.5?d/(2-a-mn):d/(a+mn);switch(a){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return[h,s,l]};this.hToC=function(x,y,h){var c;if(h<0){h+=1}if(h>1){h-=1}if(h<1/6){c=x+(y-x)*h*6}else{if(h<1/2){c=y}else{if(h<2/3){c=x+(y-x)*(2/3-h)*6}else{c=x}}}return c};this.setOptions({ctx:null,width:0,height:0,global:{},data:{},types:["fillRect","strokeRect","clearRect","arc","circle","multi","children"],styles:["stroke","fill","clear","clip"],conv:{"lw":"lineWidth","lc":"lineCap","lj":"lineJoin","ml":"miterLimit","sx":"shadowOffsetX","sy":"shadowOffsetY","sb":"shadowBlur","sc":"shadowColor","fs":"fillStyle","ss":"strokeStyle","tf":"font","ta":"textAlign","tb":"textBaseline","gco":"globalCompositeOperation","ga":"globalAlpha","a":"angle","z":"scale"},images:{},loading:0,renderOnLoad:false});if(o){this.setOptions(o)}};function textWidth(a,b){var c=document.createElement('canvas');var d=c.getContext('2d');d.font=a;return d.measureText(b).width};