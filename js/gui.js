// Lamenting Globule 0.0 (Apathetic Amoeba)
// Graphical User Interface
// lg.gui
// (c) 2011 Josh "CartLemmy" Merritt
// cartlemmy@gmail.com
// http://www.yibbleware.com

// Requires(lg.file)


function lgGUI(o){this.sri=new serverRequestInterface(this,"lg.php");try{this.geshi=new lgGeshi()}catch(e){}try{this.dataManager=new lgData()}catch(e){}this.setOptions=function(o){for(i in o){var n="set"+i.charAt(0).toUpperCase()+i.substr(1);if(this[n]){this[n](o[i])}else{this[i]=o[i]}}};this.setOptions({guiObjects:[],dontParseInner:"codedefine,code,pre,lit,anch",hasRelatedClass:"head,subhead,subsubhead,section,code,codedefine,codevar,page",noBrAfter:"head,subhead,subsubhead,code,codedefine,page,thead,tbody,tr,td,table,jump,lit,anch",layoutFunction:{head:"createAnchor",subhead:"createAnchor",toolGroup:"clearBoth"},tagTranslate:{br:{t:"br"},clear:{t:"div",a:{style:{clear:"both"}}},page:{t:"span"},lit:{t:"span"},b:{t:"span",a:{style:{fontWeight:"bold"}}},i:{t:"span",a:{style:{fontStyle:"italic"}}},u:{t:"span",a:{style:{textDecoration:"underline"}}},s:{t:"span",a:{style:{textDecoration:"line-through"}}},codevar:{t:"span"},pre:{t:"pre"},img:{t:"img",a:{src:"!data"}},text:{t:"span"},quote:{t:"blockquote",a:{innerHTML:"!data"}},size:{t:"span",a:{innerHTML:"!data",style:{fontSize:"!main"}}},color:{t:"span",a:{innerHTML:"!data",style:{color:"!main"}}},bgcolor:{t:"span",a:{innerHTML:"!data",style:{backgroundColor:"!main"}}},list:{t:"ul"},table:{t:"table"},thead:{t:"thead"},tbody:{t:"tbody"},tr:{t:"tr"},td:{t:"td",a:{className:"lgmltd"}},hr:{t:"hr"}},paramTranslate:{alt:"alt",title:"title",colspan:"colspan",rowspan:"rowspan",width:"style.width",height:"style.height",align:"style.cssFloat"}});this.remove=function(a){a=this.getHandle(a);var b=this.getContainer(this.guiObjects[a].element);b.parentNode.removeChild(b);this.guiObjects[a]=null};this.registerEvents=function(a,b,o,c){if(o.selectable){a.style.cursor="pointer"}o.element=a;a.ob=this;a.view=b;a.o=o;a.item=c;a.onclick=function(e){var o=this.o;if(o.t=="collection"){this.ob.expandOrCollapse(this.view,this.o)}else if(this.view.clickToChoose){if(o.selectable){this.ob.doCallback(b,o,copyObject(o,{e:e,action:"choose"}))}}else{}this.ob.doCallback(this.view,o,copyObject(o,{e:e,action:"click"}));if(o.parent){o.parent.select(o)}}};this.doCallback=function(a,o,b){switch(b.action){case"close":this.remove(a?a:b);break}var c=[o,o.data,a,b];for(var i in c){if(c[i]&&c[i].callback){c[i].callback(b,a,a.ob)}}};this.filter=function(o,b){if(!b||o.data==undefined)return true;var c={"file-ext":"item.path[0].search(/\.[param]$/)","mime-type":"//complex\npassed = true; var m = item.mime[0].split(';').shift().split('/'); var p = \"[param]\".split(\"/\"); for (var i in p) { if (p[i] != m[i]) { passed = false;} }"}var a=b.split(":");if(c[a[0]]){b=c[a[0]].split("[param]").join(a[1])}var d=o.data;var f=false;try{eval(b.substr(0,10)=="//complex\n"?b:"passed = ("+b+");")}catch(e){lgError(e,"Invalid filter\n"+b);return true}return f};this.createDialouge=function(o,a){if(!o.parentElement){switch(o.viewType){case"alert":o.parentElement=this.createViewContainerAlert(o);break;default:o.parentElement=document.body;break}}switch(o.t){case"fileOpen":var b=new lgFile(o);var o=optionDefaults(o,{title:"Open",layout:[{t:"treeView",data:b.getFolderContents(o.folder,true)}]});delete b;break;case"fileSave":var b=new lgFile(o);var o=optionDefaults(o,{title:"Save As",layout:[{t:"input",type:"text",label:"File Name",bind:"file",value:o.file},{t:"treeView",data:b.getFolderContents(o.folder,true)},{t:"button",action:"save",value:"Save"},{t:"button",action:"close",value:"Cancel"}]});delete b;break}return this.createView(o,a)};this.createViewContainerAlert=function(o){var c=dg("",document.body,"div",{style:{zIndex:10,position:"absolute",top:"0px",left:"0px",backgroundColor:"rgba(0,0,0,0.5)",width:docWidth()+"px",height:docHeight()+"px"},name:"lgViewContainer"});var e=dg("",c,"div",{style:{position:"absolute",overflow:"hidden",color:"#FFFFFF",fontWeight:"bold",fontSize:"16px",height:"24px"}});dg("",e,"div",{style:{cssFloat:"left",},innerHTML:"...",name:"lgTitle"});dg("",e,"div",{style:{cssFloat:"right",border:"1px solid #FFFFFF",width:"16px",height:"16px",fontSize:"12px",textAlign:"center",cursor:"pointer"},innerHTML:"X",name:"lgClose"});var d=dg("",c,"div",{style:{position:"absolute",backgroundColor:"#FFFFFF",overflowX:"hidden",overflowY:"auto"},updateSize:function(){var a=this.parentNode.childNodes[0];var b=this.childNodes[0]?{w:this.clientWidth,h:this.clientHeight}:{w:200,h:200};b.h+=15;a.style.width=this.style.width=b.w+"px";this.style.height=b.h+"px";var y=Math.round((docHeight()/2)-(b.h/2));a.style.top=(y-24)+"px";a.style.left=this.style.left=Math.round((docWidth()/2)-(b.w/2))+"px";this.style.top=y+"px"},name:"lgViewContainerInner"});d.updateSize();return d};this.updateContainer=function(o,p){if(!p){var p=this.getContainer(o.parentElement);if(!p)return}var n=["lgViewContainerInner","lgTitle","lgClose"];var c=p.childNodes;for(i in c){for(j in n){if(c[i].name==n[j]){switch(Number(j)){case 0:c[i].updateSize();break;case 1:c[i].innerHTML=o.title;break;case 2:c[i].o=o;c[i].ob=this;c[i].onclick=function(e){this.ob.doCallback(null,this.o,copyObject(this.o,{e:e,action:"close"}))}break}break}}if(c[i].childNodes&&c[i].childNodes.length){this.updateContainer(o,c[i])}}};this.getContainer=function(a){while(a.parentNode){if(a.name=="lgViewContainer"){return a}a=a.parentNode}return null};this.getHandle=function(o){if(typeof(o)=="number"){return o}return o.handle};this.createView=function(a,b){a.ob=b;if(!a.layout){return false}this.guiObjects.push(this.parseLayout(a.parentElement,a.layout,a));this.updateContainer(a);a.gui=this;return a.handle=this.guiObjects.length-1};this.view=function(a){return this.guiObjects[a]};this.createTreeView=function(o,a){if(!o.names){o.names=this.dataManager.getColNames(o.data)}if(!o.classNames){o.classNames={"table":"lgTVTable","headTr":"lgTVHeadTr","headTd":"lgTVHeadTd","bodyTr":"lgTVBodyTr","bodyTd":"lgTVBodyTd","bodyTrOdd":"lgTVBodyTrOdd","branch":"lgTVBranch","branchExpand":"lgTVBranchExpand"}}var d=dc('table');d.className=o.classNames["table"]?o.classNames["table"]:"";var b=dc('thead');b.className=o.classNames["thead"]?o.classNames["thead"]:"";var c=dc('tr');c.className=o.classNames["headTr"]?o.classNames["headTr"]:"";for(var j in o.names){var e=dc('td');e.className=o.classNames["headTd"]?o.classNames["headTd"]:"";e.innerHTML=o.names[j];c.appendChild(e)}b.appendChild(c);d.appendChild(b);var f=dc('tbody');f.className=o.classNames["tbody"]?o.classNames["tbody"]:"";this.createTreeBranch(d,o.data,o,a);d.appendChild(f);return d};this.expandOrCollapse=function(a,o){};this.createTreeBranch=function(d,o,p,a,b,c){if(!b){b=0}if(!c){c=0}for(var i in o){o[i].expanded=true;o[i].selectable=this.filter(o[i],a.filterSelectable);var e=dc('tr');e.className=(p.classNames["bodyTr"]?p.classNames["bodyTr"]:"")+(c&1&&p.classNames["bodyTrOdd"]?" "+p.classNames["bodyTrOdd"]:"");var f=true;for(var j in p.names){var g=dc('td');g.className=p.classNames["bodyTd"]?p.classNames["bodyTd"]:"";if(f){dg("",g,"div",{style:{width:(b*32)+"px",cssFloat:"left"},innerHTML:"&nbsp;"});if(o[i].data["collection"]){dg("",g,"div",{style:{cssFloat:"left"},className:(p.classNames["branch"]+(o[i].expanded?" "+p.classNames["branchExpand"]:""))})}}dg("",g,"div",{style:{cssFloat:"left"},innerHTML:this.dataManager.dataObjectToText(o[i].data[j])});this.registerEvents(g,a,o[i],j);e.appendChild(g);f=false}d.appendChild(e);c++;if(o[i].data["collection"]&&o[i].expanded){c=this.createTreeBranch(d,o[i].data["collection"][0],p,a,b+1,c)}}return c};this.createToolGroup=function(o,b,c){var d=dg("",null,"div",{className:"toolGroup",style:{}});d.o=o;o.ob=this;o.view=b;o.select=function(o){var a=getNodeTree(this.data[0].element.parentNode);for(var i in a){var s=o==i||(o.name&&o.name==i);if(s&&typeof(o)=="string"){o=a[i].o}a[i].style.margin=s?"3px":"4px";a[i].style.border=s?"1px solid #990000":"";a[i].style.backgroundColor=s?"#CCDDFF":""}this.ob.doCallback(this.view,this,copyObject(this,{selected:o.name,e:null,action:"selected"}))};return d};this.createIcon=function(o,b,c){if(c.selectable){o.parent=c}if(o.data.href){var a=dg("",null,"a",{href:o.data.href,target:o.data.target?o.data.target:""})}else{var a=null}var d=dg("",a,"div",{className:"lgIcon",style:{backgroundImage:"url("+c.path+o.data.img+".png)",margin:"4px",width:"32px",height:"32px",cursor:"pointer",cssFloat:"left"},title:o.data.title});this.registerEvents(d,b,o);return a?a:d};this.createInput=function(o,a){var d=dg("",null,"input",{onchange:function(e){if(this.o.bind){this.view[this.o.bind]=this.value}},value:o.value?o.value:""});d.o=o;d.view=a;return d};this.createButton=function(o,a){var d=dc("input");d.type="button";d.value=o.value;d.o=o;d.view=a;d.ob=this;d.onclick=function(e){this.ob.doCallback(this.view,this.o,copyObject(this.o,{e:e,action:this.o.action}))};return d};this.createUrl=function(o){var d=dc('a');d.href=o.main?o.main:o.data;d.innerHTML=o.data;if(o.target){d.target=o.target}return d};this.createAnchor=function(a,d){var b=dg("",d,"a",{name:a.data.cleanLink()},true)};this.clearBoth=function(a,d){var b=dg("",d,"div",{style:{clear:"both"}})};this.createAnch=function(o){return dg("",null,"a",{name:o.data.cleanLink()},true)};this.createJump=function(o){var d=dc('a');d.href=(o.href?o.href:"")+"#"+(o.main?o.main:o.data).cleanLink();d.innerHTML=o.data;return d};this.createWiki=function(o){var d=dc('a');d.href="http://en.wikipedia.org/wiki/"+(o.main?o.main:o.data);d.innerHTML=o.data;d.target="_blank";return d};this.createYoutube=function(o){var d=dc('iframe');d.src="http://www.youtube.com/embed/"+o.data+"/";d.width=o.width?o.width:640;d.height=o.height?o.height:390;d.frameBorder="0";d.allowfullscreen=true;return d};this.createExample=function(o){var d=dc("span");d.innerHTML="<b>"+o.data+"</b> &nbsp; <a href=\""+o.data+"\" target=\"_BLANK\">TRY</a> &nbsp; <a href=\"?viewsource="+o.data+"\" target=\"_BLANK\">VIEW SOURCE</a>";return d};this.createTab=function(o){var d=dc("span");d.innerHTML="&nbsp;&nbsp;&nbsp;&nbsp;".repeat(o.tabs?o.tabs:1);return d};this.createCodedefine=function(o){var d=dc("div");d.className="codedefine";d.innerHTML=o.lang?this.geshi.highlight(o):o.data.text2HTML();return d};this.createCode=function(o){var d=dc("div");d.className="code";d.innerHTML=o.lang?this.geshi.highlight(o):o.data.text2HTML();return d};this.parseTagTranslateParams=function(a,b,c){var d={};for(var i in a){if(typeof(a[i])=="object"){d[i]=this.parseTagTranslateParams(a[i],b,true)}else if(a[i].substr(0,1)=="!"){var t=a[i].substr(1).split("+");var e=t.length>1?t.pop():"";if(b[t[0]]!==undefined){d[i]=b[t[0]]+e}}else{d[i]=a[i]}}if(!c){for(var i in b){if(this.paramTranslate[i]){setDeepRef(d,this.paramTranslate[i],b[i])}}}return d};this.parseLayout=function(a,b,c,e){var i;for(i=0;i<b.length;i++){if(typeof(b[i])=="string"){b[i]={t:b[i],data:""};var n="none"}else{var n=b[i].t;var n="create"+n.charAt(0).toUpperCase()+n.substr(1)}if(typeof(this[n])=="function"){var d=this[n](b[i],c,e);a.appendChild(d)}else{if(this.tagTranslate[b[i].t]){var d=dg('',a,this.tagTranslate[b[i].t].t?this.tagTranslate[b[i].t].t:'div',this.parseTagTranslateParams(this.tagTranslate[b[i].t].a,b[i]))}else{var d=dg('',a,'div')}}if(b[i].name){d.name=b[i].name}if((","+this.hasRelatedClass+",").indexOf(","+b[i].t+",")!==-1){d.className=b[i].t}if(typeOf(b[i].data)=="array"){this.parseLayout(d,b[i].data,c,b[i])}else if(typeOf(b[i].data)=="string"){setInnerHTML(d,this.formatText(b[i].t,b[i].data.trim()))}if(this.layoutFunction[b[i].t]){this[this.layoutFunction[b[i].t]](b[i],d)}}if(!e){dg("",a,"div",{style:{clear:"both"}})}return{type:"view",view:c,element:a,getElement:this.getElement}};this.getElement=function(a){var t=getNodeTree(this.view.parentElement);for(var i in t){if(i==a){return t[i]}}return null};this.formatText=function(a,b){switch(a){case"code":break}return b};this.parseLayoutFromSource=function(a,b){this.parseLayout(a,this.sourceToLayout(b.wikify()))};this.sourceToLayout=function(b,c){var o=new Array();var d=0,pos=0,nextPos=-1;while((pos=b.regexIndexOf(/(\[[a-zA-z0-9]+)/,pos))!=-1){if(pos>d){o.push({t:"text",data:b.substr(d,pos-d).text2HTML()})}var e=b.substr(pos+1,(nextPos=b.indexOf("]",pos))-pos-1);nextPos++;var f=e.splitParams();var g={};for(var i=0;i<f.length;i++){var a=f[i].split("=",2);if(a.length>1){g[i?a[0]:"main"]=a[1]}if(i==0){f[i]=a[0]}}var e=f.shift();var h="[/"+e+"]";if(b.indexOf(h,nextPos+1)==-1){o.push({t:e,data:""});pos=nextPos}else{pos=this.findEndTagPos(b,pos,e);var j=b.substr(nextPos,pos-nextPos).replace(/^\n|\n$/g,"");g.t=e;g.data=(","+this.dontParseInner+",").indexOf(","+e+",")!==-1?j:this.sourceToLayout(j,true);o.push(g);pos+=h.length;if(b.substr(pos,1)=="\n"&&(","+this.noBrAfter+",").indexOf(","+e+",")!==-1){pos++}}d=pos}if(pos==-1){pos=b.length};if(pos>d&&(o.length||!c)){o.push({t:"text",data:b.substr(d,pos-d).text2HTML()})}return o.length?o:b};this.findEndTagPos=function(a,b,c){var d=b;var e=0,i=0;while(1){var f=a.indexOf("["+c,b);f=f===-1?1000000:f;var g=a.indexOf("[/"+c+"]",b);g=g===-1?1000000:g;if(f==1000000&&g==1000000){return b}else if(f<g){e++;b=a.indexOf("]",f+1)+1}else{e--;b=g;if(e==0){return b}b+=c.length+3}i++;if(i>100)return b}};if(o){this.setOptions(o)}};