// Lamenting Globule 0.0 (Apathetic Amoeba)
// 2.5d Model
// lg.model
// (c) 2011 Josh "CartLemmy" Merritt
// cartlemmy@gmail.com
// http://www.yibbleware.com


function lgModel(o){window.lgModel=this;this.colorClass=new lgColor();this.setOptions=function(o){for(i in o){var n="set"+i.charAt(0).toUpperCase()+i.substr(1);if(this[n]){this[n](o[i])}else{this[i]=o[i]}}};this.setOptions({selectedNodes:[],nodes:{},nodeCount:0,startA1:0,startA2:0,typeNames:["voxel"]});this.typeByName=function(a){for(var i=0;i<this.typeNames.length;i++){if(this.typeNames[i]==a)return i}return-1};this.prepForSave=function(){var a=this.allNodes();for(var i=0;i<a.length;i++){try{delete a[i].globalX;delete a[i].globalY;delete a[i].globalZ}catch(e){}}};this.nodeExistsAt=function(x,y,z,a){if(!a){var a=this.allNodes()}for(var i=0;i<a.length;i++){if(a[i].x==x&&a[i].y==y&&a[i].z==z){return a[i]}}return false};this.addNode=function(a,b){if(!a){var a=this.nodes}if(!a.c){a.c=[]}if(this.nodeExistsAt(b.x,b.y,b.z,a.c)){return false}else{a.c.push(b);this.nodeCount++}return true};this.colorNode=function(o){var a=null;if(a=this.nodeExistsAt(o.x,o.y,o.z,o.c)){a.f=o.f}}this.removeNodes=function(a){for(var i=0;i<a.length;i++){if(this.allNodes(false,false,a[i])){this.nodeCount--}}};this.moveNodes=function(a,t){for(var i=0;i<a.length;i++){a[i].x+=t[0];a[i].y+=t[1];a[i].z+=t[2]}};this.allNodes=function(a,b,c){if(!b){var a=[];var b=this.nodes}else{a.push(b)}if(b.c){for(var i=0;i<b.c.length;i++){if(c&&b.c[i]==c){b.c.splice(i,1);return true}if(this.allNodes(a,b.c[i],c)===true){return true}}}return a};this.setSelectedNodes=function(a){this.selectedNodes=a};this.getAngleOfXYZ=function(o){var d=Math.sqrt(o.x*o.x+o.y*o.y);o.a1=Math.atan2(o.y,o.x);d=Math.sqrt(d*d+o.z*o.z);return{a1:Math.atan2(o.y,o.x),a2:Math.atan2(o.z,d)}};this.transformTo2D=function(x,y,z,a,t){return{x:(x*t[0]+y*t[1]+z*t[2])*a,y:(x*t[3]+y*t[4]+z*t[5])*a}};this.transformTo3D=function(x,y,a,t,b){var c=[];for(var i=0;i<t.length;i++){c.push(t[i])}var d=t?{x:(t[0]*x+t[3]*y)/a,y:(t[1]*x+t[4]*y)/a,z:(t[2]*x+t[5]*y)/a}:{x:0,y:0,z:0};if(!c[0]&&!c[3]){d.x=b.x}if(!c[1]&&!c[4]){d.y=b.y}if(!c[2]&&!c[5]){d.z=b.z}return d};this.transformAngleToXYZ=function(a,b,x,y,z){var c=(Math.cos(b)*x)+((-Math.sin(b))*z);return{x:(Math.cos(a)*c)+((-Math.sin(a))*y),y:(Math.sin(a)*c)+(Math.cos(a)*y),z:(Math.sin(b)*x)+(Math.cos(b)*z)}};this.distance3d=function(x,y,z){return Math.sqrt((x===false?0:x*x)+(y===false?0:y*y)+(z===false?0:z*z))};this.draw=function(a,b,c,t,d,e,f,g,h,j){if(!d){var d=this.nodes;var p={x:0,y:0,z:0,a1:this.startA1,a2:this.startA2}}else{var p={a1:e.a1,a2:e.a2,x:e.x,y:e.y,z:e.z}}var k=this.selectedNodes.indexOf(d)!=-1;var l=this.transformAngleToXYZ(p.a1,p.a2,d.x,d.y,d.z);this.t=t;this.zoom=c;var m=false;if(!d.c){switch(f){case 1:if(Math.floor(l.x)!=g.x&&Math.floor(l.x)!=g.x-1)return;if(Math.floor(l.x)==g.x-1)m=true;break;case 2:if(Math.floor(l.y)!=g.y&&Math.floor(l.y)!=g.y-1)return;if(Math.floor(l.y)==g.y-1)m=true;break;case 3:if(Math.floor(l.z)!=g.z&&Math.floor(l.z)!=g.z-1)return;if(Math.floor(l.z)==g.z-1)m=true;break}}d.globalX=l.x;d.globalY=l.y;d.globalZ=l.z;switch(d.t){case 0:if(j){}else{if(!h){this.ctx.fillStyle=this.rgb(d.f,m?0.25:false)}if(k){this.ctx.strokeStyle="#FF0000"}this.drawVoxel(this.ctx,l,c,t,!k,h?d.f:false)}break}if(d.c){if(t[6]){d.c.sort(this.sortNodes)}for(var i=0;i<d.c.length;i++){this.draw(a,b,c,t,d.c[i],p,f,g,h,j)}}};this.sortNodes=function(a,b){var c=window.lgModel.transformTo2D(a.x,a.y,a.z,window.lgModel.zoom,window.lgModel.t);var d=window.lgModel.transformTo2D(b.x,b.y,b.z,window.lgModel.zoom,window.lgModel.t);return((a.z<<10)+c.y)-((b.z<<10)+d.y)}this.rgb=function(c,a,v){if(v){var c=(Math.max(0,Math.min(255,((c>>16)&255)+v))<<16)|(Math.max(0,Math.min(255,((c>>8)&255)+v))<<8)|Math.max(0,Math.min(255,(c&255)+v))}if(typeof(a)=="number"){return"rgba("+((c>>16)&255)+","+((c>>8)&255)+","+(c&255)+","+a+")"}else{return"rgb("+((c>>16)&255)+","+((c>>8)&255)+","+(c&255)+")"}};this.drawVoxel=function(a,p,b,t,d,c){if(c){this.drawCube(a,{x:p.x,y:p.y,z:p.z},{x:p.x+1,y:p.y+1,z:p.z+1},b,t,d,c)}else{var e=this.transformTo2D(p.x,p.y,p.z,b,t);var f=this.transformTo2D(p.x+1,p.y+1,p.z+1,b,t);var x=Math.min(e.x,f.x);var y=Math.min(e.y,f.y);a.fillRect(x,y,b,b);if(!d){a.strokeRect(x,y,b,b)}}};this.drawCube=function(a,b,d,e,t,f,c){var g=[b,d];var h=[0,0,0,0,0,64];var k=[[0,0,0,1,0,0,1,1,0,0,1,0],[0,0,0,0,1,0,0,1,1,0,0,1],[0,0,0,1,0,0,1,0,1,0,0,1],[1,0,0,1,1,0,1,1,1,1,0,1],[0,1,0,1,1,0,1,1,1,0,1,1],[0,0,1,1,0,1,1,1,1,0,1,1]];for(var i=0;i<6;i++){if(c){a.fillStyle=this.rgb(c,false,h[i])}a.beginPath();for(var j=0;j<12;j+=3){var p=this.transformTo2D(g[k[i][j]].x,g[k[i][j+1]].y,g[k[i][j+2]].z,e,t);if(!j){a.moveTo(p.x,p.y)}else{a.lineTo(p.x,p.y)}}if(!f){a.stroke()}a.fill();a.closePath()}};this.draw=function(a,b,c,t,d,e,f,g,h){if(!d){var j=true;var d=this.nodes;var p={x:0,y:0,z:0,a1:0,a2:0}}else{var j=false;var p={a1:e.a1,a2:e.a2,x:e.x,y:e.y,z:e.z}}var k=this.selectedNodes.indexOf(d)!=-1;var l=this.transformAngleToXYZ(p.a1,p.a2,d.x,d.y,d.z);this.t=t;this.zoom=c;var m=false;if(!d.c){switch(f){case 1:if(Math.floor(l.x)!=g.x&&Math.floor(l.x)!=g.x-1)return;if(Math.floor(l.x)==g.x-1)m=true;break;case 2:if(Math.floor(l.y)!=g.y&&Math.floor(l.y)!=g.y-1)return;if(Math.floor(l.y)==g.y-1)m=true;break;case 3:if(Math.floor(l.z)!=g.z&&Math.floor(l.z)!=g.z-1)return;if(Math.floor(l.z)==g.z-1)m=true;break}}d.globalX=l.x;d.globalY=l.y;d.globalZ=l.z;switch(d.t){case 0:if(!h){this.ctx.fillStyle=this.rgb(d.f,m?0.25:false)}if(k){this.ctx.strokeStyle="#FF0000"}this.drawVoxel(this.ctx,l,c,t,!k,h?d.f:false);break}if(j&&d.c){if(t[6]){d.c.sort(this.sortNodes)}for(var i=0;i<d.c.length;i++){this.draw(a,b,c,t,d.c[i],p,f,g,h)}}};this.render=function(a){this.twoXfilter=true;this.zAng=0.6666;this.outline=2;var b=this.go("size");b.rotWidth=Math.ceil(Math.max(b.x,b.y)*1.414213562);b.xOff=b.x-b.rotWidth;b.yOff=b.y-b.rotWidth;b.x=b.y=b.rotWidth;var e=new this.threeDByteArray(b.x,b.y,b.z);var f=new this.threeDByteArray(b.x*2,b.y*2,b.z*2);this.go("to3dArray",e,{x:-Math.ceil(b.xMin/2+b.xOff/4),y:-(Math.ceil(b.yMin/2+b.yOff/4)-0.5),z:-Math.ceil(b.zMin/2)});this.go("to3dArray2x",f,{x:-Math.ceil(b.xMin/2+b.xOff/4),y:-(Math.ceil(b.yMin/2+b.yOff/4)-0.5),z:-Math.ceil(b.zMin/2)});for(var z=0;z<b.z;z++){if(this.twoXfilter){for(var x=0;x<b.x;x++){for(var y=0;y<b.y;y++){var g=this.getSlope("x",{x:x,y:y,z:z},e);var h=this.getSlope("y",{x:x,y:y,z:z},e);var j=this.getSlope("z",{x:x,y:y,z:z},e);if(g!==false||h!==false||j!==false){for(var k=0;k<2;k++){for(var l=0;l<2;l++){for(var m=0;m<2;m++){var s=[g!==false?g[m*2+l]:false,h!==false?h[m*2+k]:false,j!==false?j[l*2+k]:false];var c=false,set=true;for(var i=0;i<3;i++){if(s[i]!==false){if(c===false){c=s[i]}else if(s[i]!=c){set=false;break}}}if(set){f.set(x*2+k,y*2+l,z*2+m,c)}}}}}}}}if(a){for(var i=0;i<2;i++){this.rotateSlice(f,"z",z*2+i,a)}}}var n=document.createElement('canvas');n.setAttribute('width',b.x*2+6);n.setAttribute('height',(b.y+b.z)*2+6);var o=n.getContext('2d');var p=new this.pixelData(o);var q=[{x:0,y:-1},{x:-1,y:0},{x:1,y:0},{x:0,y:1}];for(var y=0;y<b.y*2;y++){for(var x=0;x<b.x*2;x++){for(var z=0;z<b.z*2;z++){var c=f.getRGBA(x,y,z);if(c.a){var r=this.getShade(x,y,z,f);var t=Math.floor((y*this.zAng)-z)+b.z*2;c.a=127;c.r=Math.max(0,Math.min(255,c.r+r));c.g=Math.max(0,Math.min(255,c.g+r));c.b=Math.max(0,Math.min(255,c.b+r));p.set(x+2,t+2,c);p.set(x+2,t+3,c)}}}}if(this.outline){var u=document.createElement('canvas');u.setAttribute('width',b.x*2+6);u.setAttribute('height',(b.y+b.z)*2+6);var v=u.getContext('2d');var w=new this.pixelData(v);for(var y=0;y<o.canvas.height;y++){for(var x=0;x<o.canvas.width;x++){w.set(x,y,{r:0,g:0,b:0,a:255})}}for(var y=0;y<b.y*2;y++){for(var x=0;x<b.x*2;x++){for(var z=0;z<b.z*2;z++){var c=f.getRGBA(x,y,z);var t=Math.floor((y*this.zAng)-z)+b.z*2;if(c.a){var A=0x800000+y+z;var c={r:A>>16,g:(A>>8)&255,b:A&255,a:255};w.set(x+2,t+2,c);w.set(x+2,t+3,c)}}}}for(var i=0;i<this.outline;i++){var B=[];for(var y=0;y<o.canvas.height;y++){for(var x=0;x<o.canvas.width;x++){var A=w.getRGBAsInt(x,y);var C=Math.max(w.getRGBAsInt(x-1,y),Math.max(w.getRGBAsInt(x+1,y),Math.max(w.getRGBAsInt(x,y-1),w.getRGBAsInt(x,y+1))));if(A<C-8){p.set(x,y,{r:0,g:0,b:0,a:255});if(A<C-100){B.push({x:x,y:y,d:C})}}}}while(d=B.pop()){w.set(d.x,d.y,{r:d.d>>16,g:(d.d>>8)&255,b:d.d&255,a:255})}}}p.put();return o};this.getShade=function(x,y,z,a){return 0};this.rotateSlice=function(a,b,d,e){var f=[];var g=document.createElement('canvas');g.setAttribute('width',a.x);g.setAttribute('height',a.y);var h=g.getContext('2d');var j=new this.pixelData(h);for(var y=0;y<g.height;y++){for(var x=0;x<g.width;x++){var c=a.getRGBA(x,y,d);if(c.a){var k=""+c.r+"-"+c.g+"-"+c.b;if(f.indexOf(k)==-1){f.push(k)}}j.set(x,y,c)}}j.put();var l=document.createElement('canvas');l.setAttribute('width',a.x);l.setAttribute('height',a.y);var m=l.getContext('2d');m.translate(l.width/2,l.height/2);m.rotate(e);m.translate(-l.width/2,-l.height/2);m.drawImage(g,0,0);for(var i=0;i<f.length;i++){var c=f[i].split("-");f[i]={r:Number(c[0]),g:Number(c[1]),b:Number(c[2])}}var j=new this.pixelData(m);for(var y=0;y<g.height;y++){for(var x=0;x<g.width;x++){var c=j.get(x,y);a.setRGBA(x,y,d,c.r,c.g,c.b,c.a>127?127:0)}}};this.hue=function(r,g,b){var a=Math.max(r,g,b),mn=Math.min(r,g,b);var h;if(a==mn){return 0}else{var d=a-mn;switch(a){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}return h*42.5}};this.getSlope=function(a,b,d){var e=[[-1,-2],[0,-2],[1,-2],[-2,-1],[-1,-1],[0,-1],[1,-1],[2,-1],[-2,0],[-1,0],[1,0],[2,0],[-2,1],[-1,1],[0,1],[1,1],[2,1],[-1,2],[0,2],[1,2]];var f=[],colors=[];var g=d.get(b.x,b.y,b.z);if(g===0)return false;for(var i=0;i<e.length;i++){switch(a){case"x":var c=d.get(b.x,b.y+e[i][0],b.z+e[i][1]);break;case"y":var c=d.get(b.x+e[i][0],b.y,b.z+e[i][1]);break;case"z":var c=d.get(b.x+e[i][0],b.y+e[i][1],b.z);break}colors.push(c);f.push(g===c)}var h=[[2,2,2,2,0,0,2,2,2,1,0,2,2,2,2,1,2,2,2,2],[2,2,2,2,2,0,0,2,2,0,1,2,2,1,2,2,2,2,2,2],[2,2,2,2,2,0,2,1,2,0,1,2,2,2,1,2,2,2,2,2],[2,2,2,1,2,0,2,2,2,1,0,2,2,2,1,2,2,2,2,2]];var m=[[12,8,3,17,13,9,4,0,18,14,5,1,19,15,10,6,2,16,11,7],[19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],[7,11,16,2,6,10,15,19,1,5,14,18,0,4,9,13,17,3,8,12]];var n=[[0,0,1,1],[0,0,1,1],[0,1,1,1],[1,0,1,1]];var o=[[2,0,3,1],[3,2,1,0],[1,3,0,2]];var p=h.length;for(var i=0;i<3;i++){for(var j=0;j<p;j++){var l=p+(i*p)+j;h[l]=[];for(var k=0;k<h[j].length;k++){h[l][m[i][k]]=h[j][k]}n[l]=[];for(var k=0;k<n[j].length;k++){n[l][o[i][k]]=n[j][k]}}}for(var q=0;q<p;q++){for(var r=0;r<h.length;r+=p){var i=r+q;var s=true,thatC=-1;for(var j=0;j<h[i].length;j++){if(h[i][j]==0){if(thatC==-1){thatC=colors[j];if(thatC>g){s=false;break}}else if(thatC!=colors[j]){s=false;break}}if(h[i][j]!=2&&!!h[i][j]!=f[j]){s=false;break}}if(s){var t=[0,0,0,0];var u=[thatC,g];for(var j=0;j<4;j++){t[j]=u[n[i][j]]}return t}}}return false};this.pixelData=function(a){this.ctx=a;this.image=a.getImageData(0,0,a.canvas.width,a.canvas.height);this.data=this.image.data;this.set=function(x,y,c){if(x>=0&&x<this.ctx.canvas.width&&y>=0&&y<this.ctx.canvas.height){var i=(y*this.ctx.canvas.width+x)*4;this.data[i]=c.r;this.data[i+1]=c.g;this.data[i+2]=c.b;this.data[i+3]=c.a}};this.get=function(x,y){var c={r:0,g:0,b:0,a:0}if(x>=0&&x<this.ctx.canvas.width&&y>=0&&y<this.ctx.canvas.height){var i=(y*this.ctx.canvas.width+x)*4;c.r=this.data[i];c.g=this.data[i+1];c.b=this.data[i+2];c.a=this.data[i+3]}return c};this.getRGBAsInt=function(x,y){if(x>=0&&x<this.ctx.canvas.width&&y>=0&&y<this.ctx.canvas.height){var i=(y*this.ctx.canvas.width+x)*4;return this.data[i]<<16|this.data[i+1]<<8|this.data[i+2]}return 0};this.put=function(){this.image.data=this.data;this.ctx.putImageData(this.image,0,0)}};this.go=function(a,b,c,d,e){var f=null;if(!d){var g=true;this.size={x:0,y:0,z:0,xMin:100000,yMin:100000,zMin:100000,xMax:-100000,yMax:-100000,zMax:-100000};var d=this.nodes;if(!d.x)d.x=0;if(!d.y)d.y=0;if(!d.z)d.z=0;var p={x:0,y:0,z:0,a1:this.startA1,a2:this.startA2};if(!c){c={x:0,y:0,z:0}}}else{var g=false;var p={a1:e.a1,a2:e.a2,x:e.x,y:e.y,z:e.z}}var h=this.transformAngleToXYZ(p.a1,p.a2,d.x,d.y,d.z);p.x+=h.x+c.x;p.y+=h.y+c.y;p.z+=h.z+c.z;switch(a){case"size":this.size.xMin=Math.min(p.x,this.size.xMin);this.size.yMin=Math.min(p.y,this.size.yMin);this.size.zMin=Math.min(p.z,this.size.zMin);this.size.xMax=Math.max(p.x,this.size.xMax);this.size.yMax=Math.max(p.y,this.size.yMax);this.size.zMax=Math.max(p.z,this.size.zMax);break;case"to3dArray":if(d.t==0){b.set(p.x|0,p.y|0,p.z|0,d.f|0x7F000000)}break;case"to3dArray2x":if(d.t==0){var j=(p.x|0)<<1;var k=(p.y|0)<<1;var l=(p.z|0)<<1;for(z=l;z<l+2;z++){for(y=k;y<k+2;y++){for(x=j;x<j+2;x++){b.set(x,y,z,d.f|0x7F000000)}}}}break}if(d.c){for(var i=0;i<d.c.length;i++){if(d.c[i].a1){p.a1+=d.c[i].a1;p.a2+=d.c[i].a2}this.go(a,b,c,d.c[i],p)}}if(g){switch(a){case"size":this.size.xMin--;this.size.yMin--;this.size.zMin--;this.size.xMax++;this.size.yMax++;this.size.zMax++;this.size.x=this.size.xMax-this.size.xMin;this.size.y=this.size.yMax-this.size.yMin;this.size.z=this.size.zMax-this.size.zMin;f={};for(var i in this.size){f[i]=this.size[i]}break}}return f};this.threeDByteArray=function(x,y,z){this.x=x;this.y=y;this.xy=x*y;this.z=z;this.size=x*y*z;this.a=[];for(var i=0;i<this.size;i++){this.a.push(0)}this.get=function(x,y,z){if(x>=0&&x<this.x&&y>=0&&y<this.y&&z>=0&&z<this.z){return this.a[z*this.xy+y*this.x+x]}return 0};this.getRGBA=function(x,y,z){if(x>=0&&x<this.x&&y>=0&&y<this.y&&z>=0&&z<this.z){var v=this.a[z*this.xy+y*this.x+x];return{"a":(v>>24)?255:0,"r":(v>>16)&255,"g":(v>>8)&255,"b":v&255}}return{"a":0,"r":0,"g":0,"b":0}};this.setRGBA=function(x,y,z,r,g,b,a){if(x>=0&&x<this.x&&y>=0&&y<this.y&&z>=0&&z<this.z){this.a[z*this.xy+y*this.x+x]=(a<<24)|(r<<16)|(g<<8)|b}};this.set=function(x,y,z,v){if(x>=0&&x<this.x&&y>=0&&y<this.y&&z>=0&&z<this.z){this.a[z*this.xy+y*this.x+x]=v}}};if(o){this.setOptions(o)}};