// Lamenting Globule 0.0 (Apathetic Amoeba)
// 2.5d Top Down Rendering Engine
// lg.graphics.topdown
// (c) 2011 Josh "CartLemmy" Merritt
// cartlemmy@gmail.com
// http://www.yibbleware.com

//! TODO
//! Update x,y so that 0,0 is the middle of the canvas
//! Simple shading
//! Advanced skewing

//PRIVATE FUNCTIONS:calcBase2,updateSpriteSortStepsPerRow,getZForPoint,getZForPixel,getStaticSpritesForPoint,getTileCtxForPoint,renderRow,renderTile,renderTileFlat,getGradientShading,addSprite

function lgGraphicsTopdown(o){this.calcBase2=function(v){var a=0;while(v>1){a++;v/=2}return a};this.setOptions=function(o){for(i in o){var n="set"+i.charAt(0).toUpperCase()+i.substr(1);if(this[n]){this[n](o[i])}else{this[i]=o[i]}}};this.setX=function(x){this.setViewport(x,this.y)};this.setY=function(y){this.setViewport(this.x,y)};this.setZ=function(z){this.setViewport(this.x,this.y,z)};this.setZoom=function(a){this.setViewport(this.x,this.y,undefined,a)};this.updateSpriteSortStepsPerRow=function(){this.spriteSortStepsPerRow=this.tileSize/this.spriteSortStep;this.spriteSortStepsPerRowExp=this.calcBase2(this.spriteSortStepsPerRow);this.spriteBufferSize=this.rowCacheSize*this.spriteSortStepsPerRow;this.spriteBufferSizeMask=this.spriteBufferSize-1};this.clearSpriteBuffer=function(){this.spriteBuffer=[];for(var i=0;i<this.spriteBufferSize;i++){this.spriteBuffer.push([])}};this.setSpriteSortStep=function(n){this.spriteSortStep=n;this.spriteSortStepExp=this.calcBase2(n);this.updateSpriteSortStepsPerRow()};this.setRowCacheSize=function(n){this.rowCache=[];this.rowCacheSize=n;this.rowCacheSizeMask=n-1;for(var i=0;i<this.rowCacheSize;i++){this.rowCache.push({y:-1})}if(this.spriteSortStep){this.setSpriteSortStep(this.spriteSortStep)}};this.setViewport=function(x,y,z,a){this.x=x|0;this.y=y|0;if(z!=undefined){this.z=z|0}if(a!=undefined){this.zoom=a}};this.setTileSize=function(a){this.tileSize=a;this.tileSizeExp=this.calcBase2(a);this.tileSizeMask=a-1;this.updateSpriteSortStepsPerRow()};this.setOptions({rowCacheSize:64,spriteSortStep:2,shading:0,gradientStep:1,skewSteps:1,gradientCache:{},enableStaticSprites:false,maxUnsortedSpriteHeight:32,zLast:-1,yLast:-1,xLast:-1,zoomLast:1,x:0,y:0,z:0,zoom:1,fetcherParams:{},performanceParams:[{n:"shading",l:0,h:2,a:6},{n:"gradientStep",l:3,h:0,a:1,e:"pow2"},{n:"skewSteps",l:0,h:"this.calcBase2(this.tileSize)",a:8,e:"pow2"}]});this.getZForPixel=function(x,y){var a=x>>this.tileSizeExp;var b=y>>this.tileSizeExp;var c=(x&this.tileSizeMask)/this.tileSize;var d=(y&this.tileSizeMask)/this.tileSize;var e=this.getZForPoint(a,b);var f=this.getZForPoint(a+1,b);var g=this.getZForPoint(a,b+1);var h=this.getZForPoint(a+1,b+1);return(e*(1-c)+f*c)*(1-d)+(g*(1-c)+h*c)*d};this.getZForPoint=function(x,y){return 0};this.getStaticSpritesForPoint=function(x,y,n){return false};this.getTileCtxForPoint=function(x,y){var a=document.createElement('canvas');a.setAttribute('width',this.tileSize);a.setAttribute('height',this.tileSize);return a.getContext('2d')};this.initTileFetcher=function(d,v){if(v.getZForPoint){this.getZForPoint=v.getZForPoint}if(v.getStaticSpritesForPoint){this.getStaticSpritesForPoint=v.getStaticSpritesForPoint}switch(d){case"":return true;case"tile-sheet":this.fetcherParams=v;if(!v.src||!v.getTileNumberForPoint)return false;if(!v.tileSize)v.tileSize=this.tileSize;this.fetcherParams.image=new Image();this.fetcherParams.image.src=v.src;this.fetcherParams.image.ob=this;this.tileCache=[];this.fetcherParams.image.onload=function(){for(var y=0;y<this.ob.fetcherParams.image.height;y+=this.ob.fetcherParams.tileSize){for(var x=0;x<this.ob.fetcherParams.image.width;x+=this.ob.fetcherParams.tileSize){var c=document.createElement('canvas');c.setAttribute('width',this.ob.fetcherParams.tileSize);c.setAttribute('height',this.ob.fetcherParams.tileSize);c.getContext('2d').drawImage(this.ob.fetcherParams.image,x,y,this.ob.fetcherParams.tileSize,this.ob.fetcherParams.tileSize,0,0,this.ob.tileSize,this.ob.tileSize);this.ob.tileCache.push(c.getContext('2d'))}}this.ob.getTileCtxForPoint=function(x,y){var a=this.tileCache[this.getTileNumberForPoint(x,y)];if(!a){var b=document.createElement('canvas');b.setAttribute('width',this.tileSize);b.setAttribute('height',this.tileSize);return b.getContext('2d')}return a}};this.getTileNumberForPoint=v.getTileNumberForPoint;return true}return false};this.movedSinceLastDraw=function(){return(this.xLast|0)!=(this.x|0)||(this.yLast|0)!=(this.y|0)||(this.zLast|0)!=(this.z|0)||this.zoomLast!=this.zoom};this.draw=function(a){this.clearSpriteBuffer();var y=Math.max(0,(this.y>>this.tileSizeExp)-1);var c={ctx:null,x1:1,y1:1,x2:1,y2:1};var d=(a.canvas.width>>this.tileSizeExp)+2;while(c.y2-this.y>0){c=this.renderRow(y,d);a.drawImage(c.ctx.canvas,c.x1-this.x,c.y1-this.y+this.z);y--;if(y<0)break}var e=(y+1)<<this.spriteSortStepsPerRowExp;var c={ctx:null,x1:1,y1:1,x2:1,y2:1};y=Math.max(0,this.y>>this.tileSizeExp);while(c.y1-this.y<a.canvas.height){c=this.renderRow(y,d);a.drawImage(c.ctx.canvas,c.x1-this.x,c.y1-this.y+this.z);y++}var f=y<<this.spriteSortStepsPerRowExp;for(var g=e;g<f;g++){var b=this.spriteBuffer[g&this.spriteBufferSizeMask];if(b.length){for(var j=0;j<b.length;j++){var o=b[j];if(o.shadow){a.drawImage(o.shadow.ctx.canvas,(o.x-o.shadow.xBase)-this.x,((o.y-o.shadow.yBase)-this.getZForPixel(o.x,o.y))-this.y+this.z)}}}}this.xLast=this.x;this.yLast=this.y;this.zLast=this.z;this.zoomLast=this.zoom;var h=0;for(var g=e;g<f;g++){var b=this.spriteBuffer[g&this.spriteBufferSizeMask];if(b.length){for(var j=0;j<b.length;j++){var o=b[j];a.drawImage(o.ctx.canvas,(o.x-o.xBase)-this.x,((o.y-o.yBase)-o.z)-this.y+this.z);h++}b=[]}}debug("SPRITES: "+h);this.xLast=this.x;this.yLast=this.y;this.zLast=this.z;this.zoomLast=this.zoom};this.renderRow=function(a,b){var c=Math.max(0,(this.x>>this.tileSizeExp)-1);var d=a&this.rowCacheSizeMask;var e=null;var f=null;if(this.rowCache[d].tileY==a){f=this.rowCache[d];if(c>f.tileX+f.tileW||f.tileX>c+b){f=null;e={from:c,to:(c+b)}}else{if(c<f.tileX){e={from:c,to:(f.tileX-1)}}if(c+b>f.tileX+f.tileW){e={from:(f.tileX+f.tileW+1),to:(c+b)}}}}else{e={from:c,to:(c+b)}}var g=(a<<this.tileSizeExp);if(e){var h={tileX:c,tileY:a,tileW:b,ctx:null,zTop:[],zBottom:[],x1:(c<<this.tileSizeExp),y1:1000000,x2:(((c+b)<<this.tileSizeExp)+this.tileSize),y2:-1000,w:0,h:0};var k=0,zTopMax=0,zBottom=0,u=c;for(var i=0;i<b+3;i++){k=this.getZForPoint(u,a)|0;zTopMax=Math.max(zTopMax,k);h.zTop.push(k);h.y1=Math.min(g-k,h.y1);zBottom=this.getZForPoint(u,a+1)|0;h.zBottom.push(zBottom);h.y2=Math.max((g-zBottom)+this.tileSize,h.y2);u++}zTopMax+=this.maxUnsortedSpriteHeight;h.y1=h.y1-this.maxUnsortedSpriteHeight;h.w=h.x2-h.x1;h.h=h.y2-h.y1+1;var l=document.createElement('canvas');l.setAttribute('width',h.w);l.setAttribute('height',h.h);h.ctx=l.getContext('2d');var m=g-h.y1;var p=m+this.tileSize;var x=((e.from<<this.tileSizeExp)-h.x1);var n=0;for(var q=e.from;q<=e.to;q++){n=x>>this.tileSizeExp;this.renderTile(h.ctx,x,m-h.zTop[n],m-h.zTop[n+1],p-h.zBottom[n],p-h.zBottom[n+1],q,a,h.zTop,h.zBottom,n);x+=this.tileSize}if(f){h.ctx.drawImage(f.ctx.canvas,f.x1-h.x1,f.y1-h.y1)}if(this.enableStaticSprites){var x=((e.from<<this.tileSizeExp)-h.x1);var r=0,py=0;for(var q=e.from;q<=e.to;q++){var t=this.getStaticSpritesForPoint(q,a,0);for(var j=0;j<t.length;j++){var o=t[j];r=o.x+x+h.x1;py=o.y+g;if(o.shadow){h.ctx.drawImage(o.shadow.ctx.canvas,(o.x-o.shadow.xBase)+x,(o.y-o.shadow.yBase)-(this.getZForPixel(r,py)-zTopMax))}h.ctx.drawImage(o.ctx.canvas,(o.x-o.xBase)+x,(o.y-o.yBase)-((o.z?o.z:this.getZForPixel(r,py))-zTopMax))}x+=this.tileSize}}}var u=c;for(var i=0;i<b+2;i++){if(this.enableStaticSprites){var t=this.getStaticSpritesForPoint(u,a,1);for(var j=0;j<t.length;j++){var s=t[j];var x=s.x+(u<<this.tileSizeExp),y=s.y+g;this.addSprite(s.ctx,x,y,s.z?s.z:this.getZForPixel(x,y),s.xBase?s.xBase:0,s.yBase?s.yBase:0,s.shadow)}}u++}if(!e){return f}this.rowCache[d]=h;return h};this.renderTile=function(a,x,b,c,d,e,f,g,h,i,n){a.save();if(this.skewSteps>1){}else{a.transform(1,(c-b)/this.tileSize,0,(Math.ceil(Math.max(d,e))-Math.floor(Math.min(b,c))+1)/this.tileSize,x,b);this.renderTileFlat(a,x,b,c,d,e,f,g,h,i,n)}a.restore()};this.renderTileFlat=function(a,x,b,c,d,e,f,g,h,i,n){a.drawImage(this.getTileCtxForPoint(f,g).canvas,0,0);switch(this.shading){case 1:break;case 2:var j=this.tileSize<<2;var k=(Math.abs(h[n]-i[n+1])+Math.abs(h[n+1]-i[n]))/j;var l=(Math.abs(h[n+1]-i[n+2])+Math.abs(h[n+2]-i[n+1]))/j;var m=(Math.abs(i[n]-(this.getZForPoint(f+1,g+2)|0))+Math.abs(i[n+1]-(this.getZForPoint(f,g+2)|0)))/j;var o=(Math.abs(i[n+1]-(this.getZForPoint(f+2,g+2)|0))+Math.abs(i[n+2]-(this.getZForPoint(f+1,g+2)|0)))/j;a.drawImage(this.getGradientShading(k,l,m,o),0,0,this.tileSize,this.tileSize);break}};this.getGradientShading=function(a,b,c,d){var n=((a*32)|0)+"_"+((b*32)|0)+"_"+((c*32)|0)+"_"+((d*32)|0);if(this.gradientCache[n]){return this.gradientCache[n]}else{var e=this.tileSize/this.gradientStep;var f=document.createElement('canvas');f.setAttribute('width',e);f.setAttribute('height',e);var g=f.getContext('2d');g.fillStyle="#000";g.fill();var h=g.getImageData(0,0,e,e);var k=h.data;var l=3;for(var j=0;j<e;j++){var m=j/this.tileSizeMask;var o=1-m;for(var i=0;i<e;i++){var p=i/this.tileSizeMask;var q=1-p;k[l]=Math.floor(255*(o*(a*q+b*p)+m*(c*q+d*p)));l+=4}}g.putImageData(h,0,0);this.gradientCache[n]=f;return f}};this.addSprite=function(a,x,y,z,b,c,d){var i=((y|0)>>this.spriteSortStepExp)&this.spriteBufferSizeMask;this.spriteBuffer[i].push({ctx:a,x:x,y:y,z:z,xBase:b,yBase:c,shadow:d})};if(o){this.setOptions(o)}};